{"version":3,"file":"builder-es.js","sources":["../src/builder.js"],"sourcesContent":["'use strict';\nconst {rollup} = require('rollup');\nconst path = require('path');\nconst {fork} = require('child_process');\nconst logger = require('backed-logger');\nlet iterator;\nlet cache;\nlet warnings = [];\n\nconst logWorker = fork(path.join(__dirname, 'workers/log-worker.js'));\n\nasync function * bundler(bundles, fn, cb) {\n  let fns = [];\n  for (let bundle of bundles) {\n    let dest = bundle.dest;\n    bundle = bundle.bundle || bundle;\n    bundle.dest = dest;\n    fns.push(fn(bundle));\n  }\n\n  await Promise.all(fns).then(bundles => {\n    logWorker.kill('SIGINT');\n    if (global.debug) {\n      for (let warning of warnings) {\n        logger.warn(warning);\n      }\n    }\n    cb(bundles)\n  });\n}\nclass Builder {\n\n  /**\n   * convert hyphen to a javascript property srting\n   */\n  toJsProp(string) {\n    let parts = string.split('-');\n    if (parts.length > 1) {\n      string = parts[0];\n      for (let part of parts) {\n        if (parts[0] !== part) {\n          var upper = part.charAt(0).toUpperCase();\n          string += upper + part.slice(1).toLowerCase();\n        }\n      }\n    }\n    return string;\n  }\n\n  build(config) {\n    return new Promise((resolve, reject) => {\n    logWorker.send('start');\n    logWorker.send(logger._chalk('building', 'cyan'));\n    this.promiseBundles(config).then(bundles => {\n      iterator = bundler(bundles, this.bundle, bundles => {\n\n        resolve(bundles)\n      });\n      iterator.next();\n    }).catch(error => {\n      logger.warn(error);\n      reject(error);\n    });\n    });\n  }\n\n  handleFormats(bundle) {\n    return new Promise((resolve, reject) => {\n      try {\n        const format = bundle.format;\n        let dest = bundle.dest;\n        if (format === 'iife' && !bundle.moduleName) {\n          bundle.moduleName = this.toJsProp(bundle.name);\n        } else {\n          switch (format) {\n            case 'cjs':\n              dest = bundle.dest.replace('.js', '-node.js');\n              break;\n            case 'es':\n            case 'amd':\n              dest = bundle.dest.replace('.js', `-${format}.js`);\n              break;\n            default:\n              break;\n                  // do nothing\n          }\n        }\n        resolve({bundle: bundle, dest: dest, format: format});\n      } catch (err) {\n        reject(err);\n      }\n    });\n  }\n\n  promiseBundles(config) {\n    return new Promise((resolve, reject) => {\n      let formats = [];\n      let bundles = config.bundles;\n      try {\n        for (let bundle of bundles) {\n          bundle.name = bundle.name || config.name;\n          bundle.babel = bundle.babel || config.babel;\n          bundle.sourceMap = bundle.sourceMap || config.sourceMap;\n          if (config.format && typeof config.format !== 'string' && !bundle.format) {\n            for (let format of config.format) {\n              bundle.format = format;\n              formats.push(this.handleFormats(bundle));\n            }\n          } else if (bundle.format && typeof bundle.format !== 'string') {\n            for (let format of bundle.format) {\n              bundle.format = format;\n              formats.push(this.handleFormats(bundle));\n            }\n          } else {\n            formats.push(this.handleFormats(bundle));\n          }\n        }\n        Promise.all(formats).then(bundles => {\n          resolve(bundles);\n        });\n      } catch (err) {\n        reject(err);\n      }\n    });\n  }\n\n/**\n * @param {object} config\n * @param {string} config.src path/to/js\n * @param {string} config.dest destination to write to\n * @param {string} config.format format to build ['es', 'iife', 'amd', 'cjs']\n * @param {string} config.name the name of your element/app\n * @param {string} config.moduleName the moduleName for your element/app (not needed for es & cjs)\n * @param {boolean} config.sourceMap Wether or not to build sourceMaps defaults to 'true'\n * @param {object} config.plugins rollup plugins to use [see](https://github.com/rollup/rollup/wiki/Plugins)\n */\n  bundle(config = {src: null, dest: 'bundle.js', format: 'iife', name: null, plugins: [], moduleName: null, sourceMap: true}) {\n    return new Promise((resolve, reject) => {\n      let plugins = config.plugins || [];\n      if (config.babel) {\n        const babel = require('rollup-plugin-babel');\n        plugins.push(babel(config.babel));\n      }\n      rollup({\n        entry: `${process.cwd()}/${config.src}`,\n        plugins: plugins,\n        cache: cache,\n      // Use the previous bundle as starting point.\n        onwarn: warning => {\n          warnings.push(warning);\n        }\n      }).then(bundle => {\n        cache = bundle;\n        bundle.write({\n        // output format - 'amd', 'cjs', 'es', 'iife', 'umd'\n          format: config.format,\n          moduleName: config.moduleName,\n          sourceMap: config.sourceMap,\n          dest: `${process.cwd()}/${config.dest}`\n        });\n        setTimeout(() => {\n          logWorker.send(logger._chalk(`${config.name}::build finished`, 'cyan'));\n          logWorker.send('done');\n          logWorker.on('message', () => {\n            resolve();\n          })\n        }, 100);\n      }).catch(err => {\n        const code = err.code;\n        logWorker.send('pauze');\n        logger.error(err);\n        if (code === 'PLUGIN_ERROR' || code === 'UNRESOLVED_ENTRY') {\n          logWorker.kill('SIGINT');\n        } else {\n          logger.warn('trying to resume the build ...');\n          logWorker.send('resume');\n        }\n        reject(err);\n      });\n    });\n  }\n}\nexport default new Builder();\n"],"names":["bundles","fn","cb","fns","bundle","dest","push","Promise","all","then","kill","global","debug","warning","warnings","warn","bundler","rollup","require","path","fork","logger","iterator","cache","logWorker","join","__dirname","Builder","string","parts","split","length","part","upper","charAt","toUpperCase","slice","toLowerCase","config","resolve","reject","send","_chalk","promiseBundles","next","catch","error","format","moduleName","toJsProp","name","replace","err","formats","babel","sourceMap","handleFormats","src","plugins","process","cwd","write","on","code"],"mappings":"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"}