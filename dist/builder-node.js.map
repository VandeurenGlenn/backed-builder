{"version":3,"file":"builder-node.js","sources":["../src/builder.js"],"sourcesContent":["'use strict';\nconst {rollup} = require('rollup');\nconst path = require('path');\nconst {fork} = require('child_process');\nconst logger = require('backed-logger');\nlet iterator;\nlet cache;\nlet warnings = [];\n\nconst logWorker = fork(path.join(__dirname, 'workers/log-worker.js'));\n\nfunction * bundler(bundles, fn) {\n  let fns = [];\n  for (let bundle of bundles) {\n    let dest = bundle.dest;\n    bundle = bundle.bundle || bundle;\n    bundle.dest = dest;\n    fns.push(fn(bundle));\n  }\n\n  yield Promise.all(fns).then(bundles => {\n    logWorker.kill('SIGINT');\n    if (global.debug) {\n      for (let warning of warnings) {\n        logger.warn(warning);\n      }\n    }\n    return bundles;\n  });\n}\nexport default class Builder {\n\n  constructor(config) {\n    logWorker.send(logger._chalk('building', 'cyan'));\n    logWorker.send('start');\n    this.build(config);\n  }\n\n  /**\n   * convert hyphen to a javascript property srting\n   */\n  toJsProp(string) {\n    let parts = string.split('-');\n    if (parts.length > 1) {\n      string = parts[0];\n      for (let part of parts) {\n        if (parts[0] !== part) {\n          var upper = part.charAt(0).toUpperCase();\n          string += upper + part.slice(1).toLowerCase();\n        }\n      }\n    }\n    return string;\n  }\n\n  build(config) {\n    this.promiseBundles(config).then(bundles => {\n      iterator = bundler(bundles, this.bundle);\n      iterator.next();\n    }).catch(error => {\n      logger.warn(error);\n    });\n  }\n\n  handleFormats(bundle) {\n    return new Promise((resolve, reject) => {\n      try {\n        const format = bundle.format;\n        let dest = bundle.dest;\n        if (format === 'iife' && !bundle.moduleName) {\n          bundle.moduleName = this.toJsProp(bundle.name);\n        } else {\n          switch (format) {\n            case 'cjs':\n              dest = bundle.dest.replace('.js', '-node.js');\n              break;\n            case 'es':\n            case 'amd':\n              dest = bundle.dest.replace('.js', `-${format}.js`);\n              break;\n            default:\n              break;\n                  // do nothing\n          }\n        }\n        resolve({bundle: bundle, dest: dest, format: format});\n      } catch (err) {\n        reject(err);\n      }\n    });\n  }\n\n  promiseBundles(config) {\n    return new Promise((resolve, reject) => {\n      let formats = [];\n      let bundles = config.bundles;\n      try {\n        for (let bundle of bundles) {\n          bundle.name = bundle.name || config.name;\n          bundle.babel = bundle.babel || config.babel;\n          bundle.sourceMap = bundle.sourceMap || config.sourceMap;\n          if (config.format && typeof config.format !== 'string' && !bundle.format) {\n            for (let format of config.format) {\n              bundle.format = format;\n              formats.push(this.handleFormats(bundle));\n            }\n          } else if (bundle.format) {\n            formats.push(this.handleFormats(bundle));\n          } else if (!bundle.format) {\n            formats.push(this.handleFormats(bundle));\n          }\n        }\n        Promise.all(formats).then(bundles => {\n          resolve(bundles);\n        });\n      } catch (err) {\n        reject(err);\n      }\n    });\n  }\n\n/**\n * @param {object} config\n * @param {string} config.src path/to/js\n * @param {string} config.dest destination to write to\n * @param {string} config.format format to build ['es', 'iife', 'amd', 'cjs']\n * @param {string} config.name the name of your element/app\n * @param {string} config.moduleName the moduleName for your element/app (not needed for es & cjs)\n * @param {boolean} config.sourceMap Wether or not to build sourceMaps defaults to 'true'\n * @param {object} config.plugins rollup plugins to use [see](https://github.com/rollup/rollup/wiki/Plugins)\n */\n  bundle(config = {src: null, dest: 'bundle.js', format: 'iife', name: null, plugins: [], moduleName: null, sourceMap: true}) {\n    return new Promise((resolve, reject) => {\n      let plugins = config.plugins || [];\n      if (config.babel) {\n        const babel = require('rollup-plugin-babel');\n        plugins.push(babel(config.babel));\n      }\n      rollup({\n        entry: `${process.cwd()}/${config.src}`,\n        plugins: plugins,\n        cache: cache,\n        // Use the previous bundle as starting point.\n        onwarn: warning => {\n          warnings.push(warning);\n        }\n      }).then(bundle => {\n        cache = bundle;\n        bundle.write({\n          // output format - 'amd', 'cjs', 'es', 'iife', 'umd'\n          format: config.format,\n          moduleName: config.moduleName,\n          sourceMap: config.sourceMap,\n          dest: `${process.cwd()}/${config.dest}`\n        });\n        logWorker.send(logger._chalk(`${config.name}::build finished`, 'cyan'));\n        setTimeout(() => {\n          resolve();\n        }, 100);\n      }).catch(err => {\n        const code = err.code;\n        logWorker.send('pauze');\n        logger.error(err);\n        if (code === 'PLUGIN_ERROR' || code === 'UNRESOLVED_ENTRY') {\n          logWorker.kill('SIGINT');\n        } else {\n          logger.warn('trying to resume the build ...');\n          logWorker.send('resume');\n        }\n      });\n    });\n  }\n}\n"],"names":["bundler","require","rollup","path","fork","logger","iterator","cache","warnings","logWorker","join","__dirname","bundles","fn","bundle","dest","push","Promise","all","fns","then","kill","global","debug","warning","warn","Builder","config","send","_chalk","build","string","parts","split","length","part","upper","charAt","toUpperCase","slice","toLowerCase","promiseBundles","next","catch","error","resolve","reject","format","moduleName","toJsProp","name","replace","err","formats","babel","sourceMap","handleFormats","src","plugins","process","cwd","write","code"],"mappings":"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"}